<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style-settings.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1>‚öôÔ∏è Configuration</h1>
                    <p class="subtitle">Param√®tres de l'application</p>
                </div>
                <a href="/" class="btn-back">‚Üê Retour aux biblioth√®ques</a>
            </div>
        </header>

        <div class="content">
            <!-- Navigation par onglets -->
            <div class="settings-tabs">
                <button class="tab-button active" onclick="switchTab('amule')">
                    üåê aMule / eMule
                </button>
                <button class="tab-button" onclick="switchTab('ebdz')">
                    üï∏Ô∏è ebdz.net
                </button>
                <button class="tab-button" onclick="switchTab('prowlarr')">
                    üîç Prowlarr
                </button>
                <button class="tab-button" onclick="switchTab('general')" style="opacity: 0.5; cursor: not-allowed;" disabled>
                    üîß G√©n√©ral (bient√¥t)
                </button>
                <button class="tab-button" onclick="switchTab('notifications')" style="opacity: 0.5; cursor: not-allowed;" disabled>
                    üîî Notifications (bient√¥t)
                </button>
            </div>

            <!-- Contenu des onglets -->
            <div class="settings-content">
                <!-- Onglet aMule -->
                <div class="tab-content active" id="tab-amule">
                    <div class="settings-section">
                        <div class="section-header">
                            <h2>üåê Configuration aMule / eMule</h2>
                            <p class="section-description">
                                Configurez la connexion √† votre client aMule ou eMule pour ajouter automatiquement 
                                les t√©l√©chargements depuis l'interface.
                            </p>
                        </div>

                        <div class="settings-card">
                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="emuleEnabled">
                                <label for="emuleEnabled">
                                    <strong>Activer l'int√©gration aMule/eMule</strong>
                                    <span class="help-text">Permet d'ajouter des liens ED2K directement depuis l'application</span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label for="emuleType">Type de client</label>
                                <select id="emuleType" class="form-select">
                                    <option value="amule">aMule (Linux/Mac)</option>
                                    <option value="emule">eMule (Windows)</option>
                                </select>
                                <small class="help-text">S√©lectionnez le client que vous utilisez</small>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="emuleHost">H√¥te</label>
                                    <input type="text" id="emuleHost" value="127.0.0.1" placeholder="127.0.0.1">
                                    <small class="help-text">Adresse IP du serveur aMule/eMule</small>
                                </div>

                                <div class="form-group">
                                    <label for="emuleEcPort">Port External Connections (EC)</label>
                                    <input type="number" id="emuleEcPort" value="4712" placeholder="4712">
                                    <small class="help-text">Port EC configur√© dans aMule (d√©faut: 4712)</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="emulePassword">Mot de passe EC</label>
                                <div class="password-input-group">
                                    <input type="password" id="emulePassword" placeholder="Mot de passe External Connections">
                                    <button type="button" class="btn-toggle-password" onclick="togglePassword()">
                                        üëÅÔ∏è Afficher
                                    </button>
                                </div>
                                <small class="help-text">Mot de passe configur√© dans les pr√©f√©rences EC d'aMule</small>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-success" onclick="saveSettings()">
                                    üíæ Enregistrer
                                </button>
                                <button class="btn" onclick="testConnection()">
                                    üîå Tester la connexion
                                </button>
                                <button class="btn" onclick="resetSettings()">
                                    üîÑ R√©initialiser
                                </button>
                            </div>

                            <div id="settingsMessage" class="message"></div>
                        </div>

                        <!-- Aide configuration -->
                        <div class="help-section">
                            <h3>üìñ Aide √† la configuration</h3>
                            
                            <details class="help-details">
                                <summary>Comment configurer aMule sur Linux ?</summary>
                                <div class="help-content">
                                    <ol>
                                        <li>Ouvrez aMule</li>
                                        <li>Allez dans <strong>Pr√©f√©rences > Connexions √† distance</strong></li>
                                        <li>Cochez <strong>"Activer les External Connections"</strong></li>
                                        <li>D√©finissez un mot de passe EC</li>
                                        <li>Notez le port (d√©faut: 4712)</li>
                                        <li>Installez amule-utils : <code>sudo apt install amule-utils</code></li>
                                        <li>Red√©marrez aMule</li>
                                    </ol>
                                </div>
                            </details>

                            <details class="help-details">
                                <summary>Comment configurer eMule sur Windows ?</summary>
                                <div class="help-content">
                                    <ol>
                                        <li>Ouvrez eMule</li>
                                        <li>Allez dans <strong>Options > Interface Web</strong></li>
                                        <li>Cochez <strong>"Activer le serveur web"</strong></li>
                                        <li>D√©finissez un mot de passe</li>
                                        <li>Notez le port (d√©faut: 4711)</li>
                                        <li>Red√©marrez eMule</li>
                                    </ol>
                                </div>
                            </details>

                            <details class="help-details">
                                <summary>La connexion √©choue, que faire ?</summary>
                                <div class="help-content">
                                    <ul>
                                        <li>‚úÖ V√©rifiez que aMule/eMule est bien d√©marr√©</li>
                                        <li>‚úÖ V√©rifiez le mot de passe EC</li>
                                        <li>‚úÖ V√©rifiez que le port EC est correct</li>
                                        <li>‚úÖ V√©rifiez que le pare-feu n'est pas bloquant</li>
                                        <li>‚úÖ Pour aMule : v√©rifiez que amule-utils est install√©</li>
                                        <li>‚úÖ Testez avec <code>amulecmd -h 127.0.0.1 -P votreMotDePasse -c status</code></li>
                                    </ul>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>

                <!-- Onglet ebdz.net -->
                <div class="tab-content" id="tab-ebdz">
                    <div class="settings-section">
                        <div class="section-header">
                            <h2>üï∏Ô∏è Configuration ebdz.net</h2>
                            <p class="section-description">
                                Configurez vos identifiants de connexion au forum et les forums √† scraper 
                                pour alimenter votre base de donn√©es ED2K.
                            </p>
                        </div>

                        <!-- Carte identifiants -->
                        <div class="settings-card">
                            <h3 style="margin-bottom: 20px; color: #333;">üîê Identifiants du forum</h3>

                            <div class="form-group">
                                <label for="ebdzUsername">Nom d'utilisateur</label>
                                <input type="text" id="ebdzUsername" placeholder="Votre pseudo sur ebdz.net">
                                <small class="help-text">Pseudo utilis√© pour vous connecter au forum</small>
                            </div>

                            <div class="form-group">
                                <label for="ebdzPassword">Mot de passe</label>
                                <div class="password-input-group">
                                    <input type="password" id="ebdzPassword" placeholder="Votre mot de passe">
                                    <button type="button" class="btn-toggle-password" onclick="toggleEbdzPassword()">
                                        üëÅÔ∏è Afficher
                                    </button>
                                </div>
                                <small class="help-text">Mot de passe du compte forum</small>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-success" onclick="saveEbdzConfig()">
                                    üíæ Enregistrer
                                </button>
                            </div>
                            <div id="ebdzMessage" class="message"></div>
                        </div>

                        <!-- Carte forums √† scraper -->
                        <div class="settings-card" style="margin-top: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="color: #333; margin: 0;">üìÇ Forums √† scraper</h3>
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <label class="select-all-label" id="selectAllLabel" style="display:none;">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                                        <span>Tout s√©lectionner</span>
                                    </label>
                                    <button class="btn btn-success" style="padding: 8px 18px; font-size: 0.9em;" onclick="addForumRow()">
                                        ‚ûï Ajouter un forum
                                    </button>
                                </div>
                            </div>

                            <div id="forumsList">
                                <!-- Les lignes de forums sont g√©r√©es par JS -->
                            </div>

                            <div id="forumsEmptyState" class="no-forums-placeholder">
                                <p>Aucun forum configur√©. Cliquez sur <strong>‚ûï Ajouter un forum</strong> pour en ajouter un.</p>
                            </div>

                            <div class="form-actions" style="margin-top: 25px;">
                                <button class="btn btn-success" onclick="saveEbdzConfig()">
                                    üíæ Enregistrer tout
                                </button>
                                <button class="btn" onclick="runScraper()" id="btnRunScraper">
                                    üöÄ Lancer le scraper
                                </button>
                            </div>
                            <div id="ebdzMessage2" class="message"></div>
                        </div>

                        <!-- Aide -->
                        <div class="help-section">
                            <h3>üìñ Aide</h3>
                            <details class="help-details">
                                <summary>O√π trouver le code du forum (fid) ?</summary>
                                <div class="help-content">
                                    <ol>
                                        <li>Rendez-vous sur <strong>ebdz.net/forum</strong></li>
                                        <li>Ouvrez la cat√©gorie qui vous int√©resse (ex : Mangas, Films‚Ä¶)</li>
                                        <li>Dans l'URL du navigateur, vous verrez un param√®tre comme <code>fid=29</code></li>
                                        <li>C'est ce nombre qu'il faut entrer dans le champ <strong>Code du forum (fid)</strong></li>
                                    </ol>
                                </div>
                            </details>
                            <details class="help-details">
                                <summary>Qu'est-ce que "max pages" ?</summary>
                                <div class="help-content">
                                    <p>Le scraper parcourt les threads page par page. <strong>Max pages</strong> permet de limiter le nombre de pages scann√©es. Laissez le champ vide pour scraper tout le forum sans limite.</p>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>

                <!-- Onglet Prowlarr -->
                <div class="tab-content" id="tab-prowlarr">
                    <div class="settings-section">
                        <div class="section-header">
                            <h2>üîç Configuration Prowlarr</h2>
                            <p class="section-description">
                                Configurez la connexion √† votre serveur Prowlarr pour int√©grer les indexeurs 
                                et am√©liorer vos recherches de contenu.
                            </p>
                        </div>

                        <div class="settings-card">
                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="prowlarrEnabled">
                                <label for="prowlarrEnabled">
                                    <strong>Activer l'int√©gration Prowlarr</strong>
                                    <span class="help-text">Permet d'utiliser les indexeurs Prowlarr dans l'application</span>
                                </label>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="prowlarrUrl">URL du serveur</label>
                                    <input type="text" id="prowlarrUrl" placeholder="http://localhost:9696 ou http://192.168.1.100:9696">
                                    <small class="help-text">Adresse compl√®te du serveur Prowlarr (avec http:// ou https://)</small>
                                </div>

                                <div class="form-group">
                                    <label for="prowlarrPort">Port</label>
                                    <input type="number" id="prowlarrPort" value="9696" placeholder="9696">
                                    <small class="help-text">Port d'acc√®s √† Prowlarr (d√©faut: 9696)</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="prowlarrApiKey">Cl√© API</label>
                                <div class="password-input-group">
                                    <input type="password" id="prowlarrApiKey" placeholder="Votre cl√© API Prowlarr">
                                    <button type="button" class="btn-toggle-password" onclick="toggleProwlarrPassword()">
                                        üëÅÔ∏è Afficher
                                    </button>
                                </div>
                                <small class="help-text">Cl√© API disponible dans les param√®tres Prowlarr > Param√®tres > G√©n√©ral > S√©curit√©</small>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-success" onclick="saveProwlarrSettings()">
                                    üíæ Enregistrer
                                </button>
                                <button class="btn" onclick="testProwlarrConnection()">
                                    üîå Tester la connexion
                                </button>
                                <button class="btn" onclick="resetProwlarrSettings()">
                                    üîÑ R√©initialiser
                                </button>
                            </div>

                            <div id="prowlarrMessage" class="message"></div>
                        </div>

                        <!-- S√©lection des indexeurs -->
                        <div class="settings-card" style="margin-top: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="color: #333; margin: 0;">üîé Indexeurs √† utiliser</h3>
                                <button class="btn btn-success" style="padding: 8px 18px; font-size: 0.9em;" onclick="loadProwlarrIndexers()">
                                    üì• R√©cup√©rer les indexeurs
                                </button>
                            </div>

                            <div id="indexersList" style="margin-bottom: 15px;">
                                <p style="color: #999;">Cliquez sur "R√©cup√©rer les indexeurs" pour charger la liste depuis Prowlarr</p>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-success" onclick="saveProwlarrIndexers()">
                                    üíæ Enregistrer la s√©lection
                                </button>
                            </div>
                            <div id="indexersMessage" class="message"></div>
                        </div>

                        <!-- Aide configuration -->
                        <div class="help-section">
                            <h3>üìñ Aide √† la configuration</h3>
                            
                            <details class="help-details">
                                <summary>O√π trouver ma cl√© API Prowlarr ?</summary>
                                <div class="help-content">
                                    <ol>
                                        <li>Ouvrez Prowlarr dans votre navigateur</li>
                                        <li>Allez dans <strong>Param√®tres (‚öôÔ∏è) > G√©n√©ral</strong></li>
                                        <li>Faites d√©filer jusqu'√† <strong>S√©curit√©</strong></li>
                                        <li>Vous trouvez le champ <strong>Cl√© API</strong></li>
                                        <li>Copiez la cl√© et collez-la dans le formulaire ci-dessus</li>
                                    </ol>
                                </div>
                            </details>

                            <details class="help-details">
                                <summary>Comment acc√©der √† Prowlarr depuis une autre machine ?</summary>
                                <div class="help-content">
                                    <ul>
                                        <li>Si Prowlarr est sur la m√™me machine : <code>http://127.0.0.1:9696</code></li>
                                        <li>Si Prowlarr est sur une autre machine du r√©seau : <code>http://192.168.1.100:9696</code> (remplacez par l'IP)</li>
                                        <li>Assurez-vous que le port 9696 (ou celui configur√©) est accessible</li>
                                        <li>En HTTPS, utilisez <code>https://</code> au lieu de <code>http://</code></li>
                                    </ul>
                                </div>
                            </details>

                            <details class="help-details">
                                <summary>La connexion √©choue, que faire ?</summary>
                                <div class="help-content">
                                    <ul>
                                        <li>‚úÖ V√©rifiez que Prowlarr est bien d√©marr√©</li>
                                        <li>‚úÖ V√©rifiez que l'URL est correcte (avec http:// ou https://)</li>
                                        <li>‚úÖ V√©rifiez que la cl√© API est correcte</li>
                                        <li>‚úÖ V√©rifiez que le port est accessible (pare-feu)</li>
                                        <li>‚úÖ Essayez d'acc√©der √† Prowlarr dans votre navigateur pour v√©rifier que √ßa fonctionne</li>
                                    </ul>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>

                <!-- Onglet G√©n√©ral (futur) -->
                <div class="tab-content" id="tab-general">
                    <div class="settings-section">
                        <div class="section-header">
                            <h2>üîß Param√®tres g√©n√©raux</h2>
                            <p class="section-description">√Ä venir prochainement...</p>
                        </div>
                    </div>
                </div>

                <!-- Onglet Notifications (futur) -->
                <div class="tab-content" id="tab-notifications">
                    <div class="settings-section">
                        <div class="section-header">
                            <h2>üîî Notifications</h2>
                            <p class="section-description">√Ä venir prochainement...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let passwordVisible = false;
        let ebdzPasswordVisible = false;

        // ===== AMULE =====
        async function loadSettings() {
            try {
                const response = await fetch('/api/emule/config');
                const config = await response.json();
                
                document.getElementById('emuleEnabled').checked = config.enabled;
                document.getElementById('emuleType').value = config.type || 'amule';
                document.getElementById('emuleHost').value = config.host;
                document.getElementById('emuleEcPort').value = config.ec_port;
                
                if (config.password && config.password !== '****') {
                    document.getElementById('emulePassword').value = config.password;
                }
            } catch (error) {
                showMessage('settingsMessage', '‚ùå Erreur lors du chargement de la configuration', 'error');
            }
        }

        async function saveSettings() {
            const config = {
                enabled: document.getElementById('emuleEnabled').checked,
                type: document.getElementById('emuleType').value,
                host: document.getElementById('emuleHost').value,
                ec_port: parseInt(document.getElementById('emuleEcPort').value),
                password: document.getElementById('emulePassword').value
            };

            if (config.enabled && !config.password) {
                showMessage('settingsMessage', '‚ö†Ô∏è Veuillez entrer un mot de passe EC', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/emule/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('settingsMessage', '‚úÖ Configuration enregistr√©e avec succ√®s !', 'success');
                } else {
                    showMessage('settingsMessage', '‚ùå Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('settingsMessage', '‚ùå Erreur de connexion: ' + error.message, 'error');
            }
        }

        async function testConnection() {
            showMessage('settingsMessage', '‚è≥ Test de connexion en cours...', 'info');
            try {
                const response = await fetch('/api/emule/test');
                const data = await response.json();
                if (data.success) {
                    showMessage('settingsMessage', '‚úÖ Connexion r√©ussie √† aMule/eMule !', 'success');
                } else {
                    showMessage('settingsMessage', '‚ùå √âchec de la connexion: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('settingsMessage', '‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function resetSettings() {
            if (!confirm('Voulez-vous r√©initialiser la configuration aMule/eMule ?')) return;
            document.getElementById('emuleEnabled').checked = false;
            document.getElementById('emuleType').value = 'amule';
            document.getElementById('emuleHost').value = '127.0.0.1';
            document.getElementById('emuleEcPort').value = '4712';
            document.getElementById('emulePassword').value = '';
            showMessage('settingsMessage', 'üîÑ Configuration r√©initialis√©e', 'info');
        }

        function togglePassword() {
            const passwordInput = document.getElementById('emulePassword');
            const toggleButton = passwordInput.closest('.password-input-group').querySelector('.btn-toggle-password');
            passwordVisible = !passwordVisible;
            passwordInput.type = passwordVisible ? 'text' : 'password';
            toggleButton.textContent = passwordVisible ? 'üôà Masquer' : 'üëÅÔ∏è Afficher';
        }

        // ===== EBDZ.NET =====
        async function loadEbdzConfig() {
            try {
                const response = await fetch('/api/ebdz/config');
                const config = await response.json();

                document.getElementById('ebdzUsername').value = config.username || '';

                // Le serveur retourne '****' si un mot de passe existe.
                // On ne touche au champ que si c'est vide (pas de mot de passe enregistr√©).
                // Sinon on laisse ce qui est d√©j√† dans le champ (valeur tap√©e ou pr√©c√©dente).
                if (!config.password) {
                    document.getElementById('ebdzPassword').value = '';
                }

                // Charger les forums
                renderForumsList(config.forums || []);
            } catch (error) {
                showMessage('ebdzMessage', '‚ùå Erreur lors du chargement de la config ebdz', 'error');
            }
        }

        function renderForumsList(forums) {
            const list = document.getElementById('forumsList');
            const emptyState = document.getElementById('forumsEmptyState');

            list.innerHTML = '';

            if (forums.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            forums.forEach((forum, index) => {
                list.appendChild(createForumRow(forum, index));
            });
            updateSelectAllState();
        }

        function createForumRow(forum = {}, index = 0) {
            const row = document.createElement('div');
            row.className = 'forum-row';
            row.dataset.index = index;
            row.innerHTML = `
                <div class="forum-row-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" class="forum-select" checked onchange="updateSelectAllState()">
                        <span class="forum-row-label">Forum #${index + 1}</span>
                    </div>
                    <button class="btn-remove-forum" onclick="removeForumRow(this)">‚úï</button>
                </div>
                <div class="forum-row-fields">
                    <div class="form-group" style="flex:0 0 120px;">
                        <label>Code du forum (fid)</label>
                        <input type="number" class="forum-fid" value="${forum.fid || ''}" placeholder="ex: 29" min="1">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Nom de la cat√©gorie</label>
                        <input type="text" class="forum-category" value="${forum.category || ''}" placeholder="ex: Mangas">
                    </div>
                    <div class="form-group" style="flex:0 0 140px;">
                        <label>Max pages (optionnel)</label>
                        <input type="number" class="forum-max-pages" value="${forum.max_pages !== null && forum.max_pages !== undefined ? forum.max_pages : ''}" placeholder="Tout" min="1">
                    </div>
                </div>
            `;
            return row;
        }

        function addForumRow() {
            const list = document.getElementById('forumsList');
            const emptyState = document.getElementById('forumsEmptyState');
            const currentCount = list.querySelectorAll('.forum-row').length;

            list.appendChild(createForumRow({}, currentCount));
            emptyState.style.display = 'none';
            updateSelectAllState();
        }

        function removeForumRow(btn) {
            const row = btn.closest('.forum-row');
            row.remove();

            // Re-num√©roter
            const list = document.getElementById('forumsList');
            list.querySelectorAll('.forum-row').forEach((r, i) => {
                r.dataset.index = i;
                r.querySelector('.forum-row-label').textContent = `Forum #${i + 1}`;
            });

            if (list.querySelectorAll('.forum-row').length === 0) {
                document.getElementById('forumsEmptyState').style.display = 'block';
            }
            updateSelectAllState();
        }

        function collectForums() {
            const forums = [];
            document.querySelectorAll('.forum-row').forEach(row => {
                const fid = row.querySelector('.forum-fid').value.trim();
                const category = row.querySelector('.forum-category').value.trim();
                const maxPages = row.querySelector('.forum-max-pages').value.trim();

                if (fid) {
                    forums.push({
                        fid: parseInt(fid),
                        category: category || `Forum ${fid}`,
                        max_pages: maxPages ? parseInt(maxPages) : null
                    });
                }
            });
            return forums;
        }

        async function saveEbdzConfig() {
            const username = document.getElementById('ebdzUsername').value.trim();
            const password = document.getElementById('ebdzPassword').value;
            const forums = collectForums();

            if (!username) {
                showMessage('ebdzMessage', '‚ö†Ô∏è Veuillez entrer un nom d\'utilisateur', 'warning');
                return;
            }

            // Validation des forums
            for (const f of forums) {
                if (!f.category || f.category.trim() === '') {
                    showMessage('ebdzMessage', '‚ö†Ô∏è Chaque forum doit avoir un nom de cat√©gorie', 'warning');
                    return;
                }
            }

            try {
                const response = await fetch('/api/ebdz/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, password, forums })
                });
                const data = await response.json();

                if (data.success) {
                    showMessage('ebdzMessage', '‚úÖ Configuration ebdz.net enregistr√©e !', 'success');
                    showMessage('ebdzMessage2', '‚úÖ Configuration enregistr√©e !', 'success');
                    loadEbdzConfig(); // Recharger depuis le serveur pour sync
                } else {
                    showMessage('ebdzMessage', '‚ùå Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('ebdzMessage', '‚ùå Erreur: ' + error.message, 'error');
            }
        }

        // ===== SELECTION DES FORUMS =====
        function toggleSelectAll(checkbox) {
            document.querySelectorAll('.forum-select').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function updateSelectAllState() {
            const all = document.querySelectorAll('.forum-select');
            const selectAll = document.getElementById('selectAllCheckbox');
            const label = document.getElementById('selectAllLabel');

            // Cacher "Tout s√©lectionner" si moins de 2 forums
            label.style.display = all.length >= 2 ? 'flex' : 'none';

            // Mettre √† jour la classe visuelle sur chaque ligne
            all.forEach(cb => {
                cb.closest('.forum-row').classList.toggle('forum-selected', cb.checked);
            });

            if (all.length === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
                return;
            }

            const checkedCount = [...all].filter(cb => cb.checked).length;
            if (checkedCount === all.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else if (checkedCount === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else {
                selectAll.indeterminate = true;
            }
        }

        async function runScraper() {
            // Collecter uniquement les fid des forums coch√©s
            const selectedFids = [];
            document.querySelectorAll('.forum-row').forEach(row => {
                if (row.querySelector('.forum-select').checked) {
                    const fid = row.querySelector('.forum-fid').value.trim();
                    if (fid) selectedFids.push(parseInt(fid));
                }
            });

            if (selectedFids.length === 0) {
                showMessage('ebdzMessage2', '‚ö†Ô∏è Aucun forum s√©lectionn√©. Cochez au moins un forum.', 'warning');
                return;
            }

            const btn = document.getElementById('btnRunScraper');
            btn.disabled = true;
            btn.textContent = '‚è≥ Scraping...';
            showMessage('ebdzMessage2', `‚è≥ Scraping en cours pour ${selectedFids.length} forum(s)‚Ä¶ cela peut prendre du temps.`, 'info');

            try {
                const response = await fetch('/api/ebdz/scrape', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ fids: selectedFids })
                });
                const data = await response.json();

                if (data.success) {
                    showMessage('ebdzMessage2', `‚úÖ Scraping termin√© ! ${data.total_links} liens r√©cup√©r√©s sur ${data.forums_scraped} forum(s).`, 'success');
                } else {
                    showMessage('ebdzMessage2', '‚ùå Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('ebdzMessage2', '‚ùå Erreur: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Lancer le scraper';
            }
        }

        function toggleEbdzPassword() {
            const input = document.getElementById('ebdzPassword');
            const btn = input.closest('.password-input-group').querySelector('.btn-toggle-password');
            ebdzPasswordVisible = !ebdzPasswordVisible;
            input.type = ebdzPasswordVisible ? 'text' : 'password';
            btn.textContent = ebdzPasswordVisible ? 'üôà Masquer' : 'üëÅÔ∏è Afficher';
        }

        // ===== PROWLARR =====
        let prowlarrPasswordVisible = false;

        async function loadProwlarrSettings() {
            try {
                const response = await fetch('/api/prowlarr/config');
                const config = await response.json();
                
                document.getElementById('prowlarrEnabled').checked = config.enabled;
                document.getElementById('prowlarrUrl').value = config.url || '';
                document.getElementById('prowlarrPort').value = config.port || 9696;
                
                if (config.api_key && config.api_key !== '****') {
                    document.getElementById('prowlarrApiKey').value = config.api_key;
                }
            } catch (error) {
                showMessage('prowlarrMessage', '‚ùå Erreur lors du chargement de la configuration Prowlarr', 'error');
            }
        }

        async function saveProwlarrSettings() {
            const config = {
                enabled: document.getElementById('prowlarrEnabled').checked,
                url: document.getElementById('prowlarrUrl').value.trim(),
                port: parseInt(document.getElementById('prowlarrPort').value),
                api_key: document.getElementById('prowlarrApiKey').value
            };

            if (config.enabled && !config.url) {
                showMessage('prowlarrMessage', '‚ö†Ô∏è Veuillez entrer l\'URL du serveur Prowlarr', 'warning');
                return;
            }

            if (config.enabled && !config.api_key) {
                showMessage('prowlarrMessage', '‚ö†Ô∏è Veuillez entrer la cl√© API Prowlarr', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/prowlarr/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('prowlarrMessage', '‚úÖ Configuration Prowlarr enregistr√©e avec succ√®s !', 'success');
                } else {
                    showMessage('prowlarrMessage', '‚ùå Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('prowlarrMessage', '‚ùå Erreur de connexion: ' + error.message, 'error');
            }
        }

        async function testProwlarrConnection() {
            showMessage('prowlarrMessage', '‚è≥ Test de connexion en cours...', 'info');
            try {
                const response = await fetch('/api/prowlarr/test');
                const data = await response.json();
                if (data.success) {
                    showMessage('prowlarrMessage', '‚úÖ Connexion r√©ussie √† Prowlarr !', 'success');
                } else {
                    showMessage('prowlarrMessage', '‚ùå √âchec de la connexion: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('prowlarrMessage', '‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function resetProwlarrSettings() {
            if (!confirm('Voulez-vous r√©initialiser la configuration Prowlarr ?')) return;
            document.getElementById('prowlarrEnabled').checked = false;
            document.getElementById('prowlarrUrl').value = '';
            document.getElementById('prowlarrPort').value = '9696';
            document.getElementById('prowlarrApiKey').value = '';
            showMessage('prowlarrMessage', 'üîÑ Configuration r√©initialis√©e', 'info');
        }

        function toggleProwlarrPassword() {
            const input = document.getElementById('prowlarrApiKey');
            const btn = input.closest('.password-input-group').querySelector('.btn-toggle-password');
            prowlarrPasswordVisible = !prowlarrPasswordVisible;
            input.type = prowlarrPasswordVisible ? 'text' : 'password';
            btn.textContent = prowlarrPasswordVisible ? 'üôà Masquer' : 'üëÅÔ∏è Afficher';
        }

        // ===== PROWLARR INDEXERS =====
        async function loadProwlarrIndexers() {
            showMessage('indexersMessage', '‚è≥ R√©cup√©ration des indexeurs en cours...', 'info');
            try {
                const response = await fetch('/api/prowlarr/indexers');
                const data = await response.json();
                
                if (!data.success) {
                    // Afficher le message d'erreur de mani√®re lisible
                    let errorMsg = data.error || 'Erreur inconnue';
                    if (errorMsg.includes('URLs essay√©es')) {
                        // Le message contient des infos de debug, l'afficher compl√®tement
                        showMessage('indexersMessage', '‚ùå ' + errorMsg, 'error');
                    } else {
                        showMessage('indexersMessage', '‚ùå Erreur: ' + errorMsg, 'error');
                    }
                    return;
                }
                
                if (!data.indexers || data.indexers.length === 0) {
                    showMessage('indexersMessage', '‚ö†Ô∏è Aucun indexeur trouv√© dans Prowlarr', 'warning');
                }
                
                displayIndexers(data.indexers || []);
                showMessage('indexersMessage', '‚úÖ Indexeurs charg√©s avec succ√®s !', 'success');
            } catch (error) {
                showMessage('indexersMessage', '‚ùå Erreur de connexion: ' + error.message, 'error');
            }
        }

        function displayIndexers(indexers) {
            const list = document.getElementById('indexersList');
            
            if (indexers.length === 0) {
                list.innerHTML = '<p style="color: #999;">Aucun indexeur trouv√©</p>';
                return;
            }
            
            let html = '';
            indexers.forEach(indexer => {
                let categoriesHtml = '';
                
                if (indexer.categories && indexer.categories.length > 0) {
                    categoriesHtml = '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">';
                    categoriesHtml += '<strong style="display: block; margin-bottom: 8px; font-size: 0.9em;">Cat√©gories:</strong>';
                    categoriesHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px;">';
                    
                    indexer.categories.forEach(category => {
                        const isSubcategory = category.name.startsWith('  ‚Ü≥');
                        categoriesHtml += `
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85em; padding: ${isSubcategory ? '2px 0 2px 10px' : '0'};">
                                <input type="checkbox" class="category-checkbox" data-indexer-id="${indexer.id}" data-category-id="${category.id}" ${category.selected ? 'checked' : ''}>
                                <span>${category.name}</span>
                            </label>
                        `;
                    });
                    
                    categoriesHtml += '</div></div>';
                } else {
                    categoriesHtml = '<div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 3px; border-left: 3px solid #ffc107; font-size: 0.85em; color: #666;">‚ö†Ô∏è Pas de cat√©gories trouv√©es pour cet indexeur</div>';
                }
                
                html += `
                    <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; margin-bottom: 15px; background: #fafafa;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px;">
                            <input type="checkbox" id="indexer-${indexer.id}" class="indexer-checkbox" value="${indexer.id}" ${indexer.selected ? 'checked' : ''}>
                            <div style="flex: 1;">
                                <label for="indexer-${indexer.id}" style="cursor: pointer; margin: 0;">
                                    <strong>${indexer.name}</strong>
                                    <span style="color: #999; font-size: 0.9em; margin-left: 10px;">(ID: ${indexer.id})</span>
                                </label>
                                ${indexer.language ? `<div style="font-size: 0.85em; color: #666;">üåê ${indexer.language}</div>` : ''}
                            </div>
                        </div>
                        ${categoriesHtml}
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        async function saveProwlarrIndexers() {
            const selected = [];
            const selectedCategories = {};
            
            // R√©cup√©rer les indexeurs s√©lectionn√©s
            document.querySelectorAll('.indexer-checkbox:checked').forEach(checkbox => {
                selected.push(parseInt(checkbox.value));
                selectedCategories[checkbox.value.toString()] = [];
            });
            
            // R√©cup√©rer les cat√©gories s√©lectionn√©es pour chaque indexeur
            document.querySelectorAll('.category-checkbox:checked').forEach(checkbox => {
                const indexerId = checkbox.getAttribute('data-indexer-id');
                const categoryId = parseInt(checkbox.getAttribute('data-category-id'));
                
                if (selectedCategories[indexerId]) {
                    if (!Array.isArray(selectedCategories[indexerId])) {
                        selectedCategories[indexerId] = [];
                    }
                    selectedCategories[indexerId].push(categoryId);
                }
            });
            
            try {
                const response = await fetch('/api/prowlarr/indexers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        selected_indexers: selected,
                        selected_categories: selectedCategories
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('indexersMessage', '‚úÖ Indexeurs et cat√©gories enregistr√©s !', 'success');
                } else {
                    showMessage('indexersMessage', '‚ùå Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('indexersMessage', '‚ùå Erreur de connexion: ' + error.message, 'error');
            }
        }


        // ===== TABS =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // ===== MESSAGES =====
        function showMessage(elementId, text, type) {
            const msg = document.getElementById(elementId);
            msg.textContent = text;
            msg.className = 'message ' + type;
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 6000);
        }

        // ===== INIT =====
        window.addEventListener('load', () => {
            loadSettings();
            loadEbdzConfig();
            loadProwlarrSettings();
        });
    </script>
</body>
</html>
