<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import de Mangas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Navigation verticale -->
        <div class="sidebar-nav">
            <a href="/" class="nav-link">üìö Biblioth√®ques</a>
            <a href="/import" class="nav-link active">üì• Import</a>
            <a href="/discover" class="nav-link">üéØ D√©couvrir</a>
            <a href="/search" class="nav-link">üîç Recherche</a>
            <a href="/transfer" class="nav-link">‚ÜîÔ∏è Transfer</a>
            <a href="/nautiljon" class="nav-link">üåä Nautiljon</a>
            <a href="/missing-monitor" class="nav-link">üìä Surveillance</a>
            <a href="/settings" class="nav-link">‚öôÔ∏è Configuration</a>
        </div>

        <div class="main-wrapper">
            <header>
                <div class="header-content">
                    <div class="header-left">
                        <h1>üì• Import de Mangas</h1>
                        <p class="subtitle">Scannez et importez vos nouveaux mangas</p>
                    </div>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="content">
            
            <!-- Configuration de l'import automatique -->
            <div class="import-section" style="background: #f0f4ff; border-left: 4px solid #3b82f6; padding: 20px 20px; border-radius: 8px; margin-bottom: 30px;">
                <h2 style="color: #3b82f6; margin-top: 0;">‚öôÔ∏è Configuration de l'Import Automatique</h2>
                
                <div class="config-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Activation -->
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;
                                      font-weight: 500; color: #1f2937;">
                            <input type="checkbox" id="auto-import-enabled" style="width: 20px; height: 20px; cursor: pointer;">
                            <span>Activer l'import automatique</span>
                        </label>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Les fichiers auto-assignables seront import√©s automatiquement
                        </small>
                    </div>
                    
                    <!-- Intervention -->
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;
                                      font-weight: 500; color: #1f2937;">
                            <input type="checkbox" id="auto-assign-enabled" checked>
                            <span>Autoriser auto-assignation</span>
                        </label>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Les fichiers seront assign√©s automatiquement si possible
                        </small>
                    </div>
                    
                    <!-- Chemin d'import automatique -->
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="auto-import-path" style="font-weight: 500; color: #1f2937;">
                            üìÅ Chemin du r√©pertoire d'import automatique
                        </label>
                        <input type="text" id="auto-import-path" placeholder="/chemin/vers/dossier/auto-import"
                               style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Les fichiers de ce r√©pertoire seront import√©s automatiquement
                        </small>
                    </div>
                    
                    <!-- Intervalle -->
                    <div class="form-group">
                        <label for="auto-import-interval" style="font-weight: 500; color: #1f2937;">
                            ‚è±Ô∏è Fr√©quence d'import
                        </label>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <input type="number" id="auto-import-interval" value="60" min="1" max="10080"
                                   style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <select id="auto-import-interval-unit" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="minutes">Minutes</option>
                                <option value="hours">Heures</option>
                                <option value="days">Jours</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Boutons de configuration -->
                <div style="display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-success" onclick="saveAutoImportConfig()" style="background: #10b981;">
                        üíæ Enregistrer la configuration
                    </button>
                    <button class="btn" onclick="loadAutoImportConfig()" style="background: #6b7280;">
                        üîÑ Recharger
                    </button>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button class="btn" id="test-auto-import-btn" onclick="testAutoImport()" style="background: #f59e0b;">
                            ‚ñ∂Ô∏è Executer l'import maintenant
                        </button>
                        <small style="color: #f59e0b; font-style: italic; white-space: nowrap;">
                            Lance un vrai import avec auto-assignation
                        </small>
                    </div>
                </div>
                <div id="auto-import-status" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
            </div>

            <!-- Historique des imports automatiques -->
            <div class="import-section" style="background: #f3f4f6; border-left: 4px solid #8b5cf6; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="color: #8b5cf6; margin: 0;">üìã Historique des Imports</h2>
                    <button class="btn" onclick="loadImportHistory()" style="background: #8b5cf6; padding: 8px 15px; font-size: 14px;">
                        üîÑ Actualiser
                    </button>
                </div>
                
                <div id="history-container" style="display: none;">
                    <div id="history-table-wrapper" style="overflow-x: auto;">
                        <table id="history-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background: #e9d5ff; border-bottom: 2px solid #8b5cf6;">
                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Date</th>
                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Status</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">üì• Import√©s</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">üîÑ Remplac√©s</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">‚è≠Ô∏è Ignor√©s</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">‚ùå Erreurs</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="history-body"></tbody>
                        </table>
                    </div>
                    <div id="history-empty" style="padding: 20px; text-align: center; color: #666; display: none;">
                        <p>Aucun import trouv√©</p>
                    </div>
                </div>
                
                <div id="history-loading" style="text-align: center; padding: 20px; color: #666;">
                    <p>Chargement de l'historique...</p>
                </div>
            </div>
            
            <!-- S√©lection du r√©pertoire d'import -->
            <div class="import-section">
                <h2>R√©pertoire d'import</h2>
                <div class="import-path-selector">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="import-path" class="import-path-input" 
                               placeholder="/chemin/vers/dossier/import">
                        <button type="button" class="btn btn-success" onclick="scanImportDirectory()">üîç Scanner</button>
                    </div>
                    <input type="file" id="import-folder-browser" webkitdirectory directory multiple 
                           style="display: none;" onchange="handleImportFolderSelect(event)">
                    <small style="color: #666; margin-top: 8px; display: block;">üí° Le chemin est automatiquement m√©moris√© pour la prochaine fois</small>
                </div>
            </div>

            <!-- Zone de r√©sultats du scan -->
            <div id="scan-results" style="display: none;">
                <div class="import-stats">
                    <div class="stat-card">
                        <div class="stat-label">Fichiers trouv√©s</div>
                        <div class="stat-value" id="files-found">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Correspondances</div>
                        <div class="stat-value" id="matches-found">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Non assign√©s</div>
                        <div class="stat-value" id="unassigned-count">0</div>
                    </div>
                </div>

                <!-- Actions globales -->
                <div class="import-actions">
                    <button class="btn" onclick="autoMatchAll()">üéØ Auto-assignation</button>
                    <button class="btn" onclick="cleanupEmptyDirectories()" style="background: #f59e0b;">üßπ Nettoyer r√©pertoires vides</button>
                    <button class="btn btn-success" onclick="executeImport()" id="import-btn" disabled>
                        ‚úÖ Importer les fichiers s√©lectionn√©s
                    </button>
                    <button class="btn" onclick="clearImport()">üóëÔ∏è Effacer</button>
                </div>

                <!-- Liste des fichiers √† importer -->
                <div id="import-files-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Scan en cours...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de s√©lection de s√©rie/biblioth√®que -->
    <div class="modal" id="select-destination-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeDestinationModal()">√ó</span>
            <h2 class="modal-title">S√©lectionner la destination</h2>
            <p class="modal-subtitle" id="file-to-assign">Fichier: ...</p>
            
            <div class="destination-selector">
                <div class="form-group">
                    <label>Biblioth√®que</label>
                    <select id="destination-library" onchange="loadLibrarySeries()">
                        <option value="">-- S√©lectionner une biblioth√®que --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>S√©rie</label>
                    <select id="destination-series">
                        <option value="">-- S√©lectionner une s√©rie --</option>
                        <option value="__new__">‚ûï Cr√©er une nouvelle s√©rie</option>
                    </select>
                </div>

                <div class="form-group" id="new-series-name-group" style="display: none;">
                    <label>Nom de la nouvelle s√©rie</label>
                    <input type="text" id="new-series-name" placeholder="Nom de la s√©rie">
                </div>

                <div class="form-actions">
                    <button class="btn" onclick="closeDestinationModal()">Annuler</button>
                    <button class="btn btn-success" onclick="assignDestination()">Valider</button>
                </div>
            </div>
        </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/import.js') }}"></script>
    <script src="{{ url_for('static', filename='js/nav.js') }}"></script>
</body>
</html>
