<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style-settings.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1>‚öôÔ∏è Configuration</h1>
                    <p class="subtitle">Param√®tres de l'application</p>
                </div>
                <a href="/" class="btn-back">‚Üê Retour aux biblioth√®ques</a>
            </div>
        </header>

        <div class="content">
            <!-- Navigation par onglets -->
            <div class="settings-tabs">
                <button class="tab-button active" onclick="switchTab('amule')">
                    üåê aMule / eMule
                </button>
                <button class="tab-button" onclick="switchTab('general')" style="opacity: 0.5; cursor: not-allowed;" disabled>
                    üîß G√©n√©ral (bient√¥t)
                </button>
                <button class="tab-button" onclick="switchTab('notifications')" style="opacity: 0.5; cursor: not-allowed;" disabled>
                    üîî Notifications (bient√¥t)
                </button>
            </div>

            <!-- Contenu des onglets -->
            <div class="settings-content">
                <!-- Onglet aMule -->
                <div class="tab-content active" id="tab-amule">
                    <div class="settings-section">
                        <div class="section-header">
                            <h2>üåê Configuration aMule / eMule</h2>
                            <p class="section-description">
                                Configurez la connexion √† votre client aMule ou eMule pour ajouter automatiquement 
                                les t√©l√©chargements depuis l'interface.
                            </p>
                        </div>

                        <div class="settings-card">
                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="emuleEnabled">
                                <label for="emuleEnabled">
                                    <strong>Activer l'int√©gration aMule/eMule</strong>
                                    <span class="help-text">Permet d'ajouter des liens ED2K directement depuis l'application</span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label for="emuleType">Type de client</label>
                                <select id="emuleType" class="form-select">
                                    <option value="amule">aMule (Linux/Mac)</option>
                                    <option value="emule">eMule (Windows)</option>
                                </select>
                                <small class="help-text">S√©lectionnez le client que vous utilisez</small>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="emuleHost">H√¥te</label>
                                    <input type="text" id="emuleHost" value="127.0.0.1" placeholder="127.0.0.1">
                                    <small class="help-text">Adresse IP du serveur aMule/eMule</small>
                                </div>

                                <div class="form-group">
                                    <label for="emuleEcPort">Port External Connections (EC)</label>
                                    <input type="number" id="emuleEcPort" value="4712" placeholder="4712">
                                    <small class="help-text">Port EC configur√© dans aMule (d√©faut: 4712)</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="emulePassword">Mot de passe EC</label>
                                <div class="password-input-group">
                                    <input type="password" id="emulePassword" placeholder="Mot de passe External Connections">
                                    <button type="button" class="btn-toggle-password" onclick="togglePassword()">
                                        üëÅÔ∏è Afficher
                                    </button>
                                </div>
                                <small class="help-text">Mot de passe configur√© dans les pr√©f√©rences EC d'aMule</small>
                            </div>

                            <div class="form-actions">
                                <button class="btn btn-success" onclick="saveSettings()">
                                    üíæ Enregistrer
                                </button>
                                <button class="btn" onclick="testConnection()">
                                    üîå Tester la connexion
                                </button>
                                <button class="btn" onclick="resetSettings()">
                                    üîÑ R√©initialiser
                                </button>
                            </div>

                            <div id="settingsMessage" class="message"></div>
                        </div>

                        <!-- Aide configuration -->
                        <div class="help-section">
                            <h3>üìñ Aide √† la configuration</h3>
                            
                            <details class="help-details">
                                <summary>Comment configurer aMule sur Linux ?</summary>
                                <div class="help-content">
                                    <ol>
                                        <li>Ouvrez aMule</li>
                                        <li>Allez dans <strong>Pr√©f√©rences > Connexions √† distance</strong></li>
                                        <li>Cochez <strong>"Activer les External Connections"</strong></li>
                                        <li>D√©finissez un mot de passe EC</li>
                                        <li>Notez le port (d√©faut: 4712)</li>
                                        <li>Installez amule-utils : <code>sudo apt install amule-utils</code></li>
                                        <li>Red√©marrez aMule</li>
                                    </ol>
                                </div>
                            </details>

                            <details class="help-details">
                                <summary>Comment configurer eMule sur Windows ?</summary>
                                <div class="help-content">
                                    <ol>
                                        <li>Ouvrez eMule</li>
                                        <li>Allez dans <strong>Options > Interface Web</strong></li>
                                        <li>Cochez <strong>"Activer le serveur web"</strong></li>
                                        <li>D√©finissez un mot de passe</li>
                                        <li>Notez le port (d√©faut: 4711)</li>
                                        <li>Red√©marrez eMule</li>
                                    </ol>
                                </div>
                            </details>

                            <details class="help-details">
                                <summary>La connexion √©choue, que faire ?</summary>
                                <div class="help-content">
                                    <ul>
                                        <li>‚úÖ V√©rifiez que aMule/eMule est bien d√©marr√©</li>
                                        <li>‚úÖ V√©rifiez le mot de passe EC</li>
                                        <li>‚úÖ V√©rifiez que le port EC est correct</li>
                                        <li>‚úÖ V√©rifiez que le pare-feu n'est pas bloquant</li>
                                        <li>‚úÖ Pour aMule : v√©rifiez que amule-utils est install√©</li>
                                        <li>‚úÖ Testez avec <code>amulecmd -h 127.0.0.1 -P votreMotDePasse -c status</code></li>
                                    </ul>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>

                <!-- Onglet G√©n√©ral (futur) -->
                <div class="tab-content" id="tab-general">
                    <div class="settings-section">
                        <div class="section-header">
                            <h2>üîß Param√®tres g√©n√©raux</h2>
                            <p class="section-description">√Ä venir prochainement...</p>
                        </div>
                    </div>
                </div>

                <!-- Onglet Notifications (futur) -->
                <div class="tab-content" id="tab-notifications">
                    <div class="settings-section">
                        <div class="section-header">
                            <h2>üîî Notifications</h2>
                            <p class="section-description">√Ä venir prochainement...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let passwordVisible = false;

        async function loadSettings() {
            try {
                const response = await fetch('/api/emule/config');
                const config = await response.json();
                
                document.getElementById('emuleEnabled').checked = config.enabled;
                document.getElementById('emuleType').value = config.type || 'amule';
                document.getElementById('emuleHost').value = config.host;
                document.getElementById('emuleEcPort').value = config.ec_port;
                
                // Ne pas afficher le mot de passe masqu√©
                if (config.password && config.password !== '****') {
                    document.getElementById('emulePassword').value = config.password;
                }
            } catch (error) {
                showMessage('‚ùå Erreur lors du chargement de la configuration', 'error');
                console.error('Erreur:', error);
            }
        }

        async function saveSettings() {
            const config = {
                enabled: document.getElementById('emuleEnabled').checked,
                type: document.getElementById('emuleType').value,
                host: document.getElementById('emuleHost').value,
                ec_port: parseInt(document.getElementById('emuleEcPort').value),
                password: document.getElementById('emulePassword').value
            };

            // Validation
            if (config.enabled && !config.password) {
                showMessage('‚ö†Ô∏è Veuillez entrer un mot de passe EC', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/emule/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage('‚úÖ Configuration enregistr√©e avec succ√®s !', 'success');
                } else {
                    showMessage('‚ùå Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Erreur de connexion: ' + error.message, 'error');
            }
        }

        async function testConnection() {
            showMessage('‚è≥ Test de connexion en cours...', 'info');
            
            try {
                const response = await fetch('/api/emule/test');
                const data = await response.json();
                
                if (data.success) {
                    showMessage('‚úÖ Connexion r√©ussie √† aMule/eMule !', 'success');
                } else {
                    showMessage('‚ùå √âchec de la connexion: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function resetSettings() {
            if (!confirm('Voulez-vous r√©initialiser la configuration aMule/eMule ?')) {
                return;
            }

            document.getElementById('emuleEnabled').checked = false;
            document.getElementById('emuleType').value = 'amule';
            document.getElementById('emuleHost').value = '127.0.0.1';
            document.getElementById('emuleEcPort').value = '4712';
            document.getElementById('emulePassword').value = '';
            
            showMessage('üîÑ Configuration r√©initialis√©e', 'info');
        }

        function togglePassword() {
            const passwordInput = document.getElementById('emulePassword');
            const toggleButton = document.querySelector('.btn-toggle-password');
            
            passwordVisible = !passwordVisible;
            
            if (passwordVisible) {
                passwordInput.type = 'text';
                toggleButton.textContent = 'üôà Masquer';
            } else {
                passwordInput.type = 'password';
                toggleButton.textContent = 'üëÅÔ∏è Afficher';
            }
        }

        function switchTab(tabName) {
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activer l'onglet s√©lectionn√©
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        function showMessage(text, type) {
            const msg = document.getElementById('settingsMessage');
            msg.textContent = text;
            msg.className = 'message ' + type;
            msg.style.display = 'block';
            
            setTimeout(() => {
                msg.style.display = 'none';
            }, 5000);
        }

        // Charger les param√®tres au d√©marrage
        window.addEventListener('load', loadSettings);
    </script>
</body>
</html>
